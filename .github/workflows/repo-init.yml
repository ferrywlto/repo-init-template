name: Initialize Repository

on:
  workflow_dispatch:
  create:
    types: repository

jobs:
  create-repo:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      REPO_NAME: ${{ github.repository }}
      REPO_OWNER: ${{ github.repository_owner }}
      AUTH_HEADER: "Authorization: token ${{ secrets.GITHUB_TOKEN }}"
      ACCEPT_HEADER: "Accept: application/vnd.github.v3+json"
      STRICT_RULE: |
        {
          "required_pull_request_reviews": {
              "required_approving_review_count": 2,
              "dismissal_restrictions": {
                  "users": [],
                  "teams": [],
                  "teams_strict": true
              }
          },
          "required_status_checks": {
              "strict": true,
              "contexts": [
                  "continuous-integration"
              ]
          },
          "enforce_admins": true,
          "restrictions": {
              "users": [],
              "teams": [
                  "merge-managers"
              ],
              "teams_strict": true
          },
          "allow_squash_merge": true,
          "allow_merge_commit": false,
          "allow_rebase_merge": true
        }
      LOOSE_RULE: |
        {
          "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismissal_restrictions": {
                  "users": [],
                  "teams": [],
                  "teams_strict": true
              }
          },
          "required_status_checks": {
              "strict": true,
              "contexts": [
                  "continuous-integration"
              ]
          },
          "enforce_admins": true,
          "restrictions": {
              "users": [],
              "teams": [
                  "merge-managers"
              ],
              "teams_strict": true
          },
        }
    steps:
      - name: Create default branches
        run: |
          git init
          git checkout -b development
          git push -u origin development
          git checkout -b staging
          git push -u origin staging
          git checkout -b production
          git push -u origin production

      - name: Create branch protection (main)
        run: |
          curl -X PUT -H $AUTH_HEADER -H $ACCEPT_HEADER -d $STRICT_RULE \
          https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/branches/main/protection

      - name: Create branch protection (staging)
        run: |
          curl -X PUT -H $AUTH_HEADER -H $ACCEPT_HEADER -d $STRICT_RULE \
          https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/branches/staging/protection

      - name: Create branch protection (production)
        run: |
          curl -X PUT -H $AUTH_HEADER -H $ACCEPT_HEADER -d $STRICT_RULE \
          https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/branches/production/protection

      - name: Create branch protection (development)
        run: |
          curl -X PUT -H $AUTH_HEADER -H $ACCEPT_HEADER -d $LOOSE_RULE \
          https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/branches/development/protection

      - name: Create branch protection (release/[0-9]*.[0-9]*.[0-9]*)
        run: |
          curl -X PUT -H $AUTH_HEADER -H $ACCEPT_HEADER -d $LOOSE_RULE \
          https://api.github.com/repos/$REPO_OWNER/$REPO_NAME/branches/release%2F%5B0-9%5D*.%5B0-9%5D*.%5B0-9%5D*/protection
